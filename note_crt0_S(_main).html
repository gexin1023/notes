<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>crt0,S(_main)代码分析</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="i4ai" id="crt0smain代码分析">crt0,S(_main)代码分析</h1><hr><div class="md-section-divider"></div><h2 data-anchor-id="z32l" id="1-设置sp寄存器地址">1. 设置sp寄存器地址</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="thij"><ol class="linenums"><li class="L0"><code class="language-C"><span class="com">//设置SP栈指针</span></code></li><li class="L1"><code class="language-C"><span class="com">#if defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span></code></li><li class="L2"><code class="language-C"><span class="pln">    ldr sp</span><span class="pun">,</span><span class="pln"> </span><span class="pun">=(</span><span class="pln">CONFIG_SPL_STACK</span><span class="pun">)</span></code></li><li class="L3"><code class="language-C"><span class="com">#else</span></code></li><li class="L4"><code class="language-C"><span class="pln">    ldr sp</span><span class="pun">,</span><span class="pln"> </span><span class="pun">=(</span><span class="pln">CONFIG_SYS_INIT_SP_ADDR</span><span class="pun">)</span></code></li><li class="L5"><code class="language-C"><span class="com">#endif</span></code></li><li class="L6"><code class="language-C"></code></li><li class="L7"><code class="language-C"><span class="com">//设置地址八位对齐</span></code></li><li class="L8"><code class="language-C"><span class="com">#if defined(CONFIG_CPU_V7M) /* v7M forbids using SP as BIC destination*/</span></code></li><li class="L9"><code class="language-C"><span class="pln">    mov r3</span><span class="pun">,</span><span class="pln"> sp             </span></code></li><li class="L0"><code class="language-C"><span class="pln">    bic r3</span><span class="pun">,</span><span class="pln"> r3</span><span class="pun">,</span><span class="pln"> </span><span class="com">#7         //* 后三位清零相当于堆栈地址八位对齐</span></code></li><li class="L1"><code class="language-C"><span class="pln">    mov sp</span><span class="pun">,</span><span class="pln"> r3               </span></code></li><li class="L2"><code class="language-C"><span class="com">#else</span></code></li><li class="L3"><code class="language-C"><span class="pln">    bic sp</span><span class="pun">,</span><span class="pln"> sp</span><span class="pun">,</span><span class="pln"> </span><span class="com">#7  /* 8-byte alignment for ABI compliance */   </span></code></li><li class="L4"><code class="language-C"><span class="com">#endif</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="4gnw" id="2-在栈中为全局变量gd分配空间">2. 在栈中为全局变量gd分配空间</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="p93e"><ol class="linenums"><li class="L0"><code><span class="com">// r0寄存器传递函数的参数</span></code></li><li class="L1"><code><span class="pln">mov r0</span><span class="pun">,</span><span class="pln"> sp</span></code></li><li class="L2"><code><span class="pln">bl  board_init_f_alloc_reserve  </span><span class="com">//在栈中为全局数据分配空间</span></code></li><li class="L3"><code><span class="pln">mov sp</span><span class="pun">,</span><span class="pln"> r0      </span></code></li><li class="L4"><code><span class="com">//函数调用后返回值在r0中，将其保存到sp寄存器中  </span></code></li><li class="L5"><code><span class="com">//根据下面的board_init_f_alloc_reserve函数</span></code></li><li class="L6"><code><span class="com">//函数返回值为分配gb后的指针位置</span></code></li></ol></pre><p data-anchor-id="vlrv">board_init_f_alloc_reserve函数原型如下：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="0fmm"><ol class="linenums"><li class="L0"><code><span class="kwd">ulong</span><span class="pln"> board_init_f_alloc_reserve</span><span class="pun">(</span><span class="kwd">ulong</span><span class="pln"> top</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">    </span><span class="com">//将栈顶指针传进来，栈顶指针减去全局变量的长度意味着数据入栈，即在栈里预留变量存储空间。</span></code></li><li class="L3"><code><span class="pln">    </span><span class="com">/* Reserve early malloc arena */</span></code></li><li class="L4"><code><span class="com">#if defined(CONFIG_SYS_MALLOC_F)</span></code></li><li class="L5"><code><span class="pln">    top </span><span class="pun">-=</span><span class="pln"> CONFIG_SYS_MALLOC_F_LEN</span><span class="pun">;</span></code></li><li class="L6"><code><span class="com">#endif</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com">/* LAST : reserve GD (rounded up to a multiple of 16 bytes) */</span></code></li><li class="L8"><code><span class="pln">    top </span><span class="pun">=</span><span class="pln"> rounddown</span><span class="pun">(</span><span class="pln">top</span><span class="pun">-</span><span class="kwd">sizeof</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> global_data</span><span class="pun">),</span><span class="pln"> </span><span class="lit">16</span><span class="pun">);</span></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> top</span><span class="pun">;</span></code></li><li class="L0"><code><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="jdpe" id="3-在栈中gd空间清零">3. 在栈中gd空间清零</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="llbp"><ol class="linenums"><li class="L0"><code><span class="pln">    mov r9</span><span class="pun">,</span><span class="pln"> r0  </span><span class="com">//将栈顶指针存到r9寄存器里面,方便后续设置gd指针</span></code></li><li class="L1"><code><span class="pln">    bl  board_init_f_init_reserve   </span><span class="com">//全局数据全部清零</span></code></li></ol></pre><p data-anchor-id="r7a9">board_init_f_init_reserve   函数定义如下：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="mhgd"><ol class="linenums"><li class="L0"><code><span class="kwd">void</span><span class="pln"> board_init_f_init_reserve</span><span class="pun">(</span><span class="kwd">ulong</span><span class="pln"> </span><span class="kwd">base</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">struct</span><span class="pln"> global_data </span><span class="pun">*</span><span class="pln">gd_ptr</span><span class="pun">;</span></code></li><li class="L3"><code><span class="com">#ifndef</span><span class="pln"> _USE_MEMCPY</span></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">int</span><span class="pln"> </span><span class="pun">*</span><span class="pln">ptr</span><span class="pun">;</span></code></li><li class="L5"><code><span class="com">#endif</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">    </span><span class="com">/*</span></code></li><li class="L8"><code><span class="com">     * clear GD entirely and set it up.</span></code></li><li class="L9"><code><span class="com">     * Use gd_ptr, as gd may not be properly set yet.</span></code></li><li class="L0"><code><span class="com">     * 清除GD分配空间</span></code></li><li class="L1"><code><span class="com">     */</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">    gd_ptr </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> global_data </span><span class="pun">*)</span><span class="kwd">base</span><span class="pun">;</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com">/* zero the area */</span></code></li><li class="L5"><code><span class="com">#ifdef</span><span class="pln"> _USE_MEMCPY</span></code></li><li class="L6"><code><span class="pln">    memset</span><span class="pun">(</span><span class="pln">gd_ptr</span><span class="pun">,</span><span class="pln"> </span><span class="str">'\0'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(*</span><span class="pln">gd</span><span class="pun">));</span><span class="pln">  </span><span class="com">//全局数据区全部清零</span></code></li><li class="L7"><code><span class="com">#else</span></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">ptr </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">gd_ptr</span><span class="pun">;</span><span class="pln"> ptr </span><span class="pun">&lt;</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> </span><span class="pun">*)(</span><span class="pln">gd_ptr </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span><span class="pln"> </span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">*</span><span class="pln">ptr</span><span class="pun">++</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L0"><code><span class="com">#endif</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">    </span><span class="com">/* set GD unless architecture did it already */</span></code></li><li class="L3"><code><span class="com">#if !defined(CONFIG_ARM)</span></code></li><li class="L4"><code><span class="pln">    arch_setup_gd</span><span class="pun">(</span><span class="pln">gd_ptr</span><span class="pun">);</span></code></li><li class="L5"><code><span class="com">#endif</span></code></li><li class="L6"><code><span class="pln">    </span><span class="com">/* next alloc will be higher by one GD plus 16-byte alignment */</span></code></li><li class="L7"><code><span class="pln">    </span><span class="kwd">base</span><span class="pln"> </span><span class="pun">+=</span><span class="pln"> roundup</span><span class="pun">(</span><span class="kwd">sizeof</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> global_data</span><span class="pun">),</span><span class="pln"> </span><span class="lit">16</span><span class="pun">);</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">    </span><span class="com">/*</span></code></li><li class="L0"><code><span class="com">     * record early malloc arena start.</span></code></li><li class="L1"><code><span class="com">     * Use gd as it is now properly set for all architectures.</span></code></li><li class="L2"><code><span class="com">     */</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="com">#if defined(CONFIG_SYS_MALLOC_F)</span></code></li><li class="L5"><code><span class="pln">    </span><span class="com">/* go down one 'early malloc arena' */</span></code></li><li class="L6"><code><span class="pln">    gd</span><span class="pun">-&gt;</span><span class="pln">malloc_base </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">base</span><span class="pun">;</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com">/* next alloc will be higher by one 'early malloc arena' size */</span></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">base</span><span class="pln"> </span><span class="pun">+=</span><span class="pln"> CONFIG_SYS_MALLOC_F_LEN</span><span class="pun">;</span></code></li><li class="L9"><code><span class="com">#endif</span></code></li><li class="L0"><code><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="hxdl" id="4-调用boardinitf初始化各种硬件">4. 调用board_init_f，初始化各种硬件</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="hylp"><ol class="linenums"><li class="L0"><code><span class="pln">    mov r0</span><span class="pun">,</span><span class="pln"> </span><span class="com">#0</span></code></li><li class="L1"><code><span class="pln">    bl  board_init_f    </span><span class="com">// jump to ==&gt; board_f.c</span></code></li></ol></pre><p data-anchor-id="pnu0">在board_init_f函数中所进行的主要操作如下，其中init_sequence_f[ ]是一个数组，其内容为一系列初始化函数，在函数initcall_run_list中依次调用init_sequence_f数组的各个初始化函数。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="v7rb"><ol class="linenums"><li class="L0"><code><span class="kwd">void</span><span class="pln"> board_init_f</span><span class="pun">(</span><span class="kwd">ulong</span><span class="pln"> boot_flags</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">    </span><span class="com">//此处省略多行代码</span></code></li><li class="L3"><code><span class="pln">    gd</span><span class="pun">-&gt;</span><span class="pln">flags </span><span class="pun">=</span><span class="pln"> boot_flags</span><span class="pun">;</span></code></li><li class="L4"><code><span class="pln">    gd</span><span class="pun">-&gt;</span><span class="pln">have_console </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L5"><code><span class="pln">    </span><span class="com">//通过调用initcall_run_list函数，执行各项初始化   </span></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">initcall_run_list</span><span class="pun">(</span><span class="pln">init_sequence_f</span><span class="pun">))</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln">        hang</span><span class="pun">();</span></code></li><li class="L8"><code><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="k7q1">initcall_run_list函数如下：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="8xq5"><ol class="linenums"><li class="L0"><code><span class="kwd">int</span><span class="pln"> initcall_run_list</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">init_fnc_t</span><span class="pln"> init_sequence</span><span class="pun">[])</span></code></li><li class="L1"><code><span class="pun">{</span><span class="pln">   </span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">const</span><span class="pln"> </span><span class="typ">init_fnc_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln">init_fnc_ptr</span><span class="pun">;</span></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">init_fnc_ptr </span><span class="pun">=</span><span class="pln"> init_sequence</span><span class="pun">;</span><span class="pln"> </span><span class="pun">*</span><span class="pln">init_fnc_ptr</span><span class="pun">;</span><span class="pln"> </span><span class="pun">++</span><span class="pln">init_fnc_ptr</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">int</span><span class="pln"> ret</span><span class="pun">;</span></code></li><li class="L5"><code><span class="pln">        </span><span class="com">//此处省略很多代码</span></code></li><li class="L6"><code><span class="pln">        </span><span class="com">//通过函数指针依次调用数组内函数</span></code></li><li class="L7"><code><span class="pln">        ret </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(*</span><span class="pln">init_fnc_ptr</span><span class="pun">)();</span><span class="pln">        </span></code></li><li class="L8"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L9"><code><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L0"><code><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="rz43">数组init_sequence_f[ ]定义如下，每个成员为一个函数指针，函数参数为void，返回类型为int</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ch5r"><ol class="linenums"><li class="L0"><code><span class="kwd">static</span><span class="pln"> </span><span class="typ">init_fnc_t</span><span class="pln"> init_sequence_f</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="com">#ifdef</span><span class="pln"> CONFIG_SANDBOX</span></code></li><li class="L2"><code><span class="pln">    setup_ram_buf</span><span class="pun">,</span></code></li><li class="L3"><code><span class="com">#endif</span></code></li><li class="L4"><code><span class="pln">    setup_mon_len</span><span class="pun">,</span></code></li><li class="L5"><code><span class="com">#ifdef</span><span class="pln"> CONFIG_OF_CONTROL</span></code></li><li class="L6"><code><span class="pln">    fdtdec_setup</span><span class="pun">,</span></code></li><li class="L7"><code><span class="com">#endif</span></code></li><li class="L8"><code><span class="com">#ifdef</span><span class="pln"> CONFIG_TRACE</span></code></li><li class="L9"><code><span class="pln">    trace_early_init</span><span class="pun">,</span></code></li><li class="L0"><code><span class="com">#endif</span></code></li><li class="L1"><code><span class="pln">    initf_malloc</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">    initf_console_record</span><span class="pun">,</span></code></li><li class="L3"><code><span class="com">#if defined(CONFIG_MPC85xx) || defined(CONFIG_MPC86xx)</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com">/* TODO: can this go into arch_cpu_init()? */</span></code></li><li class="L5"><code><span class="pln">    probecpu</span><span class="pun">,</span></code></li><li class="L6"><code><span class="com">#endif</span></code></li><li class="L7"><code><span class="com">#if defined(CONFIG_X86) &amp;&amp; defined(CONFIG_HAVE_FSP)</span></code></li><li class="L8"><code><span class="pln">    x86_fsp_init</span><span class="pun">,</span></code></li><li class="L9"><code><span class="com">#endif</span></code></li><li class="L0"><code><span class="pln">    arch_cpu_init</span><span class="pun">,</span><span class="pln">      </span><span class="com">/* basic arch cpu dependent setup */</span></code></li><li class="L1"><code><span class="pln">    mach_cpu_init</span><span class="pun">,</span><span class="pln">      </span><span class="com">/* SoC/machine dependent CPU setup */</span></code></li><li class="L2"><code><span class="pln">    initf_dm</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">    arch_cpu_init_dm</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">    mark_bootstage</span><span class="pun">,</span><span class="pln">     </span><span class="com">/* need timer, go after init dm */</span></code></li><li class="L5"><code><span class="com">#if defined(CONFIG_BOARD_EARLY_INIT_F)</span></code></li><li class="L6"><code><span class="pln">    board_early_init_f</span><span class="pun">,</span></code></li><li class="L7"><code><span class="com">#endif</span></code></li><li class="L8"><code><span class="pln">    </span><span class="com">/* TODO: can any of this go into arch_cpu_init()? */</span></code></li><li class="L9"><code><span class="com">#if defined(CONFIG_PPC) &amp;&amp; !defined(CONFIG_8xx_CPUCLK_DEFAULT)</span></code></li><li class="L0"><code><span class="pln">    get_clocks</span><span class="pun">,</span><span class="pln">     </span><span class="com">/* get CPU and bus clocks (etc.) */</span></code></li><li class="L1"><code><span class="com">#if defined(CONFIG_TQM8xxL) &amp;&amp; !defined(CONFIG_TQM866M) \</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">!</span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_TQM885D</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">    adjust_sdram_tbs_8xx</span><span class="pun">,</span></code></li><li class="L4"><code><span class="com">#endif</span></code></li><li class="L5"><code><span class="pln">    </span><span class="com">/* TODO: can we rename this to timer_init()? */</span></code></li><li class="L6"><code><span class="pln">    init_timebase</span><span class="pun">,</span></code></li><li class="L7"><code><span class="com">#endif</span></code></li><li class="L8"><code><span class="com">#if defined(CONFIG_ARM) || defined(CONFIG_MIPS) || \</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_BLACKFIN</span><span class="pun">)</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> </span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_NDS32</span><span class="pun">)</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> \</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_SH</span><span class="pun">)</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> </span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_SPARC</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">    timer_init</span><span class="pun">,</span><span class="pln">     </span><span class="com">/* initialize timer */</span></code></li><li class="L2"><code><span class="com">#endif</span></code></li><li class="L3"><code><span class="com">#ifdef</span><span class="pln"> CONFIG_SYS_ALLOC_DPRAM</span></code></li><li class="L4"><code><span class="com">#if !defined(CONFIG_CPM2)</span></code></li><li class="L5"><code><span class="pln">    dpram_init</span><span class="pun">,</span></code></li><li class="L6"><code><span class="com">#endif</span></code></li><li class="L7"><code><span class="com">#endif</span></code></li><li class="L8"><code><span class="com">#if defined(CONFIG_BOARD_POSTCLK_INIT)</span></code></li><li class="L9"><code><span class="pln">    board_postclk_init</span><span class="pun">,</span></code></li><li class="L0"><code><span class="com">#endif</span></code></li><li class="L1"><code><span class="com">#if defined(CONFIG_SYS_FSL_CLK) || defined(CONFIG_M68K)</span></code></li><li class="L2"><code><span class="pln">    get_clocks</span><span class="pun">,</span></code></li><li class="L3"><code><span class="com">#endif</span></code></li><li class="L4"><code><span class="pln">    env_init</span><span class="pun">,</span><span class="pln">       </span><span class="com">/* initialize environment */</span></code></li><li class="L5"><code><span class="com">#if defined(CONFIG_8xx_CPUCLK_DEFAULT)</span></code></li><li class="L6"><code><span class="pln">    </span><span class="com">/* get CPU and bus clocks according to the environment variable */</span></code></li><li class="L7"><code><span class="pln">    get_clocks_866</span><span class="pun">,</span></code></li><li class="L8"><code><span class="pln">    </span><span class="com">/* adjust sdram refresh rate according to the new clock */</span></code></li><li class="L9"><code><span class="pln">    sdram_adjust_866</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pln">    init_timebase</span><span class="pun">,</span></code></li><li class="L1"><code><span class="com">#endif</span></code></li><li class="L2"><code><span class="pln">    init_baud_rate</span><span class="pun">,</span><span class="pln">     </span><span class="com">/* initialze baudrate settings */</span></code></li><li class="L3"><code><span class="pln">    serial_init</span><span class="pun">,</span><span class="pln">        </span><span class="com">/* serial communications setup */</span></code></li><li class="L4"><code><span class="pln">    console_init_f</span><span class="pun">,</span><span class="pln">     </span><span class="com">/* stage 1 init of console */</span></code></li><li class="L5"><code><span class="com">#ifdef</span><span class="pln"> CONFIG_SANDBOX</span></code></li><li class="L6"><code><span class="pln">    sandbox_early_getopt_check</span><span class="pun">,</span></code></li><li class="L7"><code><span class="com">#endif</span></code></li><li class="L8"><code><span class="pln">    display_options</span><span class="pun">,</span><span class="pln">    </span><span class="com">/* say that we are here */</span></code></li><li class="L9"><code><span class="pln">    display_text_info</span><span class="pun">,</span><span class="pln">  </span><span class="com">/* show debugging info if required */</span></code></li><li class="L0"><code><span class="com">#if defined(CONFIG_MPC8260)</span></code></li><li class="L1"><code><span class="pln">    prt_8260_rsr</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">    prt_8260_clks</span><span class="pun">,</span></code></li><li class="L3"><code><span class="com">#endif</span><span class="pln"> </span><span class="com">/* CONFIG_MPC8260 */</span></code></li><li class="L4"><code><span class="com">#if defined(CONFIG_MPC83xx)</span></code></li><li class="L5"><code><span class="pln">    prt_83xx_rsr</span><span class="pun">,</span></code></li><li class="L6"><code><span class="com">#endif</span></code></li><li class="L7"><code><span class="com">#if defined(CONFIG_PPC) || defined(CONFIG_M68K) || defined(CONFIG_SH)</span></code></li><li class="L8"><code><span class="pln">    checkcpu</span><span class="pun">,</span></code></li><li class="L9"><code><span class="com">#endif</span></code></li><li class="L0"><code><span class="pln">    print_cpuinfo</span><span class="pun">,</span><span class="pln">      </span><span class="com">/* display cpu info (and speed) */</span></code></li><li class="L1"><code><span class="com">#if defined(CONFIG_MPC5xxx)</span></code></li><li class="L2"><code><span class="pln">    prt_mpc5xxx_clks</span><span class="pun">,</span></code></li><li class="L3"><code><span class="com">#endif</span><span class="pln"> </span><span class="com">/* CONFIG_MPC5xxx */</span></code></li><li class="L4"><code><span class="com">#if defined(CONFIG_DTB_RESELECT)</span></code></li><li class="L5"><code><span class="pln">    embedded_dtb_select</span><span class="pun">,</span></code></li><li class="L6"><code><span class="com">#endif</span></code></li><li class="L7"><code><span class="com">#if defined(CONFIG_DISPLAY_BOARDINFO)</span></code></li><li class="L8"><code><span class="pln">    show_board_info</span><span class="pun">,</span></code></li><li class="L9"><code><span class="com">#endif</span></code></li><li class="L0"><code><span class="pln">    INIT_FUNC_WATCHDOG_INIT</span></code></li><li class="L1"><code><span class="com">#if defined(CONFIG_MISC_INIT_F)</span></code></li><li class="L2"><code><span class="pln">    misc_init_f</span><span class="pun">,</span></code></li><li class="L3"><code><span class="com">#endif</span></code></li><li class="L4"><code><span class="pln">    INIT_FUNC_WATCHDOG_RESET</span></code></li><li class="L5"><code><span class="com">#if defined(CONFIG_HARD_I2C) || defined(CONFIG_SYS_I2C)</span></code></li><li class="L6"><code><span class="pln">    init_func_i2c</span><span class="pun">,</span></code></li><li class="L7"><code><span class="com">#endif</span></code></li><li class="L8"><code><span class="com">#if defined(CONFIG_HARD_SPI)</span></code></li><li class="L9"><code><span class="pln">    init_func_spi</span><span class="pun">,</span></code></li><li class="L0"><code><span class="com">#endif</span></code></li><li class="L1"><code><span class="pln">    announce_dram_init</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">    </span><span class="com">/* TODO: unify all these dram functions? */</span></code></li><li class="L3"><code><span class="com">#if defined(CONFIG_ARM) || defined(CONFIG_X86) || defined(CONFIG_NDS32) || \</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_MICROBLAZE</span><span class="pun">)</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> </span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_AVR32</span><span class="pun">)</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> \</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_SH</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">    dram_init</span><span class="pun">,</span><span class="pln">      </span><span class="com">/* configure available RAM banks */</span></code></li><li class="L7"><code><span class="com">#endif</span></code></li><li class="L8"><code><span class="com">#if defined(CONFIG_MIPS) || defined(CONFIG_PPC) || defined(CONFIG_M68K)</span></code></li><li class="L9"><code><span class="pln">    init_func_ram</span><span class="pun">,</span></code></li><li class="L0"><code><span class="com">#endif</span></code></li><li class="L1"><code><span class="com">#ifdef</span><span class="pln"> CONFIG_POST</span></code></li><li class="L2"><code><span class="pln">    post_init_f</span><span class="pun">,</span></code></li><li class="L3"><code><span class="com">#endif</span></code></li><li class="L4"><code><span class="pln">    INIT_FUNC_WATCHDOG_RESET</span></code></li><li class="L5"><code><span class="com">#if defined(CONFIG_SYS_DRAM_TEST)</span></code></li><li class="L6"><code><span class="pln">    testdram</span><span class="pun">,</span></code></li><li class="L7"><code><span class="com">#endif</span><span class="pln"> </span><span class="com">/* CONFIG_SYS_DRAM_TEST */</span></code></li><li class="L8"><code><span class="pln">    INIT_FUNC_WATCHDOG_RESET</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="com">#ifdef</span><span class="pln"> CONFIG_POST</span></code></li><li class="L1"><code><span class="pln">    init_post</span><span class="pun">,</span></code></li><li class="L2"><code><span class="com">#endif</span></code></li><li class="L3"><code><span class="pln">    INIT_FUNC_WATCHDOG_RESET</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com">/*</span></code></li><li class="L5"><code><span class="com">     * Now that we have DRAM mapped and working, we can</span></code></li><li class="L6"><code><span class="com">     * relocate the code and continue running from DRAM.</span></code></li><li class="L7"><code><span class="com">     *</span></code></li><li class="L8"><code><span class="com">     * Reserve memory at end of RAM for (top down in that order):</span></code></li><li class="L9"><code><span class="com">     *  - area that won't get touched by U-Boot and Linux (optional)</span></code></li><li class="L0"><code><span class="com">     *  - kernel log buffer</span></code></li><li class="L1"><code><span class="com">     *  - protected RAM</span></code></li><li class="L2"><code><span class="com">     *  - LCD framebuffer</span></code></li><li class="L3"><code><span class="com">     *  - monitor code</span></code></li><li class="L4"><code><span class="com">     *  - board info struct</span></code></li><li class="L5"><code><span class="com">     */</span></code></li><li class="L6"><code><span class="pln">    setup_dest_addr</span><span class="pun">,</span></code></li><li class="L7"><code><span class="com">#if defined(CONFIG_BLACKFIN) || defined(CONFIG_XTENSA)</span></code></li><li class="L8"><code><span class="pln">    </span><span class="com">/* Blackfin u-boot monitor should be on top of the ram */</span></code></li><li class="L9"><code><span class="pln">    reserve_uboot</span><span class="pun">,</span></code></li><li class="L0"><code><span class="com">#endif</span></code></li><li class="L1"><code><span class="com">#if defined(CONFIG_SPARC)</span></code></li><li class="L2"><code><span class="pln">    reserve_prom</span><span class="pun">,</span></code></li><li class="L3"><code><span class="com">#endif</span></code></li><li class="L4"><code><span class="com">#if defined(CONFIG_LOGBUFFER) &amp;&amp; !defined(CONFIG_ALT_LB_ADDR)</span></code></li><li class="L5"><code><span class="pln">    reserve_logbuffer</span><span class="pun">,</span></code></li><li class="L6"><code><span class="com">#endif</span></code></li><li class="L7"><code><span class="com">#ifdef</span><span class="pln"> CONFIG_PRAM</span></code></li><li class="L8"><code><span class="pln">    reserve_pram</span><span class="pun">,</span></code></li><li class="L9"><code><span class="com">#endif</span></code></li><li class="L0"><code><span class="pln">    reserve_round_4k</span><span class="pun">,</span></code></li><li class="L1"><code><span class="com">#if !(defined(CONFIG_SYS_ICACHE_OFF) &amp;&amp; defined(CONFIG_SYS_DCACHE_OFF)) &amp;&amp; \</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_ARM</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">    reserve_mmu</span><span class="pun">,</span></code></li><li class="L4"><code><span class="com">#endif</span></code></li><li class="L5"><code><span class="com">#ifdef</span><span class="pln"> CONFIG_DM_VIDEO</span></code></li><li class="L6"><code><span class="pln">    reserve_video</span><span class="pun">,</span></code></li><li class="L7"><code><span class="com">#else</span></code></li><li class="L8"><code><span class="com"># ifdef CONFIG_LCD</span></code></li><li class="L9"><code><span class="pln">    reserve_lcd</span><span class="pun">,</span></code></li><li class="L0"><code><span class="com"># endif</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com">/* TODO: Why the dependency on CONFIG_8xx? */</span></code></li><li class="L2"><code><span class="com"># if defined(CONFIG_VIDEO) &amp;&amp; (!defined(CONFIG_PPC) || defined(CONFIG_8xx)) &amp;&amp; \</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">!</span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_ARM</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">!</span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_X86</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">!</span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_BLACKFIN</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">!</span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_M68K</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">    reserve_legacy_video</span><span class="pun">,</span></code></li><li class="L6"><code><span class="com"># endif</span></code></li><li class="L7"><code><span class="com">#endif</span><span class="pln"> </span><span class="com">/* CONFIG_DM_VIDEO */</span></code></li><li class="L8"><code><span class="pln">    reserve_trace</span><span class="pun">,</span></code></li><li class="L9"><code><span class="com">#if !defined(CONFIG_BLACKFIN) &amp;&amp; !defined(CONFIG_XTENSA)</span></code></li><li class="L0"><code><span class="pln">    reserve_uboot</span><span class="pun">,</span></code></li><li class="L1"><code><span class="com">#endif</span></code></li><li class="L2"><code><span class="com">#ifndef</span><span class="pln"> CONFIG_SPL_BUILD</span></code></li><li class="L3"><code><span class="pln">    reserve_malloc</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">    reserve_board</span><span class="pun">,</span></code></li><li class="L5"><code><span class="com">#endif</span></code></li><li class="L6"><code><span class="pln">    setup_machine</span><span class="pun">,</span></code></li><li class="L7"><code><span class="pln">    reserve_global_data</span><span class="pun">,</span></code></li><li class="L8"><code><span class="pln">    reserve_fdt</span><span class="pun">,</span></code></li><li class="L9"><code><span class="pln">    reserve_arch</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pln">    reserve_stacks</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">    setup_dram_config</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">    show_dram_config</span><span class="pun">,</span></code></li><li class="L3"><code><span class="com">#if defined(CONFIG_M68K) || defined(CONFIG_MIPS) || defined(CONFIG_PPC) || \</span></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">defined</span><span class="pun">(</span><span class="pln">CONFIG_SH</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">    setup_board_part1</span><span class="pun">,</span></code></li><li class="L6"><code><span class="com">#endif</span></code></li><li class="L7"><code><span class="com">#if defined(CONFIG_PPC) || defined(CONFIG_M68K)</span></code></li><li class="L8"><code><span class="pln">    INIT_FUNC_WATCHDOG_RESET</span></code></li><li class="L9"><code><span class="pln">    setup_board_part2</span><span class="pun">,</span></code></li><li class="L0"><code><span class="com">#endif</span></code></li><li class="L1"><code><span class="pln">    display_new_sp</span><span class="pun">,</span></code></li><li class="L2"><code><span class="com">#ifdef</span><span class="pln"> CONFIG_SYS_EXTBDINFO</span></code></li><li class="L3"><code><span class="pln">    setup_board_extra</span><span class="pun">,</span></code></li><li class="L4"><code><span class="com">#endif</span></code></li><li class="L5"><code><span class="pln">    INIT_FUNC_WATCHDOG_RESET</span></code></li><li class="L6"><code><span class="pln">    reloc_fdt</span><span class="pun">,</span></code></li><li class="L7"><code><span class="pln">    setup_reloc</span><span class="pun">,</span></code></li><li class="L8"><code><span class="com">#if defined(CONFIG_X86) || defined(CONFIG_ARC)</span></code></li><li class="L9"><code><span class="pln">    copy_uboot_to_ram</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pln">    clear_bss</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">    do_elf_reloc_fixups</span><span class="pun">,</span></code></li><li class="L2"><code><span class="com">#endif</span></code></li><li class="L3"><code><span class="com">#if defined(CONFIG_XTENSA)</span></code></li><li class="L4"><code><span class="pln">    clear_bss</span><span class="pun">,</span></code></li><li class="L5"><code><span class="com">#endif</span></code></li><li class="L6"><code><span class="com">#if !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_SANDBOX)</span></code></li><li class="L7"><code><span class="pln">    jump_to_copy</span><span class="pun">,</span></code></li><li class="L8"><code><span class="com">#endif</span></code></li><li class="L9"><code><span class="pln">    NULL</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pun">};</span></code></li></ol></pre></div>
</body>
</html>